<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>GooseWatch 2014</title>

		<!-- Bootstrap CSS -->
		<link href="css/bootstrap.min.css" rel="stylesheet">
		<link href="css/bootstrap-theme.min.css" rel="stylesheet">
		<!-- FontAwesome CSS -->
		<link rel="stylesheet" href="font-awesome-4.0.3/css/font-awesome.min.css">
		<!-- Esri CSS -->
		<link rel="stylesheet" type="text/css" href="http://js.arcgis.com/3.8/js/esri/css/esri.css">
		<link rel="stylesheet" type='text/css' href='http://serverapi.arcgisonline.com/jsapi/arcgis/2.4/js/esri/dijit/css/Popup.css'/>
		<link rel="stylesheet" type='text/css' href='http://serverapi.arcgisonline.com/jsapi/arcgis/2.4/js/esri/dijit/css/PopupMobile.css'/>
		<style>
		html,body,#mapDiv,.map.container{
		  padding:0;
		  margin:0;
		  height:100%;
		}
		.navbar{
			margin-bottom: 0;
		}
		</style>
	
		<!-- ESRI JS API -->
		<script src="http://js.arcgis.com/3.8/"></script>

		<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
		<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
		<!--[if lt IE 9]>
		  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
		  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
		<![endif]-->
		
		<!-- Brains -->
		<script>

			//Globals
			var map;
			var gooseNestsURL = "https://services1.arcgis.com/DwLTn0u9VBSZvUPe/arcgis/rest/services/GooseWatch14/FeatureServer/0";
			var geometryServiceURL = "http://env-gisdev.uwaterloo.ca/arcgis/rest/services/Utilities/Geometry/GeometryServer";
			var routeTaskURL = "http://env-gisdev.uwaterloo.ca/arcgis/rest/services/Campus/uw_route/NAServer/Route?token=oxSF0Agd5ZoDEqJX3b0hcn4im9yhLs-yeQbAgxTn7gfD20WSqbk9qYBpaZMqVwBb86GV79qfaAu_3zsawq3tpzBefVkbcK81hghgCggBWEI.";
			var uwBldgsURL = "https://api.uwaterloo.ca/v2/buildings/list.json?key=cb63602dd1fd2a14332405f8613b68ed&output=json&callback=populateBuildings&jsonp=?";
			var gooseFL;
			var x, y;
			var offCampusBuildings = ["AAC","AAR","PHR","ARC","GA","HSC","WSS","180King"];
			var buildings;
			var results;
			var stopSymbol, routeSymbol;
			var routeParams, routeTask;
			var bufferGraphics;
			var bufferParams;
			var gsvc;
			var nestBuffers = [];
			var addPointMode = false;
	
			require(["esri/map", "esri/arcgis/utils","esri/layers/FeatureLayer","esri/tasks/FeatureSet","esri/layers/GraphicsLayer","esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleLineSymbol","esri/tasks/RouteTask","esri/tasks/RouteParameters","esri/tasks/GeometryService","esri/tasks/query","esri/geometry/webMercatorUtils","esri/dijit/PopupTemplate","esri/dijit/PopupMobile","dojo/dom-construct","dojo/domReady!"], function(Map,arcgisUtils,FeatureLayer,FeatureSet,GraphicsLayer,SimpleMarkerSymbol,SimpleLineSymbol,RouteTask,RouteParameters,GeometryService,Query,webMercatorUtils,PopupTemplate,PopupMobile,domConstruct){
		
				gsvc = new GeometryService(geometryServiceURL);
		
				// Show start screen
				$(window).load(function(){
					$('#startScreenModal').modal('show');
				});
		
				//Create nested feature set to hold nest buffers at three levels
				buildings = new FeatureSet();
				nestBuffers.push(new esri.tasks.FeatureSet());
				nestBuffers.push(new esri.tasks.FeatureSet());
				nestBuffers.push(new esri.tasks.FeatureSet());
				
				//create a popup to replace the map's info window
				var popup = new PopupMobile(null, dojo.create("div"));
				
				
				//Create the map
				map = new Map("mapDiv",{
					basemap: "topo",
					center: [-80.542, 43.471],
					zoom: 16,
					infoWindow: popup
				});
				
				/*var infoWindow = new InfoWindowLite(null, domConstruct.create("div", null, null, map.root));
				infoWindow.startup();
				map.setInfoWindow(infoWindow);*/
				
				
				
				//Create a new lat/long point when the user clicks on the map (if in add point mode)
				map.on("click",function(ev){
					if(addPointMode){
						var webmercPt = ev.mapPoint;
						var llPt = webMercatorUtils.webMercatorToGeographic(webmercPt);
						populateLocationFromClick(llPt);
					}
				});
				
				
				//Initialize map contents once map has loaded
				map.on("load", initLayers);
				
				
	  
				/**
					initLayers()
					
					Initializes all the layers after the map has loaded
				*/
				function initLayers(){
					
					//Create the goose nest feature layer
					//Using MODE_SELECTION because it's the only way I can find to make sure the nests are loaded before making buffers
					gooseFL = new FeatureLayer(gooseNestsURL,{
						mode: FeatureLayer.MODE_SELECTION,
						outFields: ["*"]
					});
					
					//When the features are selected create the nest buffers
					gooseFL.on("selection-complete",makeNestBuffers);
					//Add attachments if they exist once a new feature is created
					gooseFL.on("edits-complete",attachPhoto);
					
					//This is based on the forum post here: http://forums.arcgis.com/threads/77989-Display-Image-Attachments-in-Popup
					gooseFL.on("click",function(e){
						var objectId, el;
						objectId = e.graphic.attributes[gooseFL.objectIdField];
						gooseFL.queryAttachmentInfos(objectId, function (infos) {
							map.infoWindow.setTitle(objectId);
							
							
							var d = new Date(e.graphic.attributes.DateSubmit);
							
							$("#nestDate")[0].innerHTML = "Date: " + d.toLocaleDateString();
							$("#nestDescription")[0].innerHTML = "Location: " + e.graphic.attributes.LocDescrip;
							$("#nestSubmitter")[0].innerHTML = "Submitted by: " + e.graphic.attributes.Submitter;
							$("#nestTwitter")[0].innerHTML = "Twitter: " + e.graphic.attributes.TwitterSub;
							if(!!$("#nestImagePlaceholder").children()){
								$("#nestImagePlaceholder").children().remove();
							}
							
							if (!!infos[0]) {
								el = document.createElement('img');
								el.setAttribute('src', infos[0].url);
								el.setAttribute('style','width:90%');
								$("#nestImagePlaceholder").prepend(el);
								$("#nestModal").modal("show");
							}
							else{
								$("#nestModal").modal("show");
							}
						});
					});
					
					map.addLayer(gooseFL);

					//Create graphics layers to hold buffer graphics and route results
					results = new GraphicsLayer();
					bufferGraphics = new GraphicsLayer();
				  
					//Set up routing parameters
					routeTask = new RouteTask(routeTaskURL);
					routeParams = new RouteParameters();
					routeParams.stops = new FeatureSet();
					routeParams.polygonBarriers = new FeatureSet();
					routeParams.returnPolygonBarriers = true;
					routeParams.outSpatialReference = {"wkid":102100};
					routeParams.doNotLocateOnRestrictedElements = true;
					
					//Routing events
					routeTask.on("solve-complete",showRoute);
					routeTask.on("error",routeErrorHandler);
				  
					//Set up routing symbology
					stopSymbol = new SimpleMarkerSymbol().setStyle(esri.symbol.SimpleMarkerSymbol.STYLE_X).setSize(15);
					stopSymbol.outline.setWidth(3);
					routeSymbol = new SimpleLineSymbol().setColor(new dojo.Color([0,0,255,0.5])).setWidth(4);

					
					// Get building data from uWaterloo API
					dojo.io.script.get({
						url: uwBldgsURL
					});
					
					//Add graphics layers to map
					map.addLayer(results);
					map.addLayer(bufferGraphics,0);
					
					//Select all nests to get them on the map
					var selectAll = new Query;
					selectAll.where = "1=1";
					gooseFL.selectFeatures(selectAll,FeatureLayer.SELECTION_NEW);			
				}  
			});
		</script>
	</head>
	<body>
		<!-- Header navigation bar -->
		<nav class="navbar navbar-inverse" role="navigation">
			<div class="container-fluid">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
						<span class="sr-only">Toggle navigation</span>
						<i class="fa fa-bars" style="color:white;"></i>
					</button>
					<a class="navbar-brand" href="#">GooseWatch 2014</a>
				</div>
				 <!-- Collect the nav links, forms, and other content for toggling -->
				<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
					<ul class="nav navbar-nav">
						<li><a href="#" data-toggle="modal" data-target="#addLocationModal">Report a Nest</a></li>
						<li><a href="#" data-toggle="modal" data-target="#findRouteModal">Navigate</a></li>
					</ul>
				</div>
			</div>
		</nav>
		
		<!-- Modal for start screen -->
		<div class="modal fade" id="startScreenModal" tabindex="-1" role="dialog" aria-labelledby="startScreenModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h4 class="modal-title" id="startScreenModalLabel">GooseWatch14</h4>
					</div>
					<div class="modal-body">
						<p class="text-center">What would you like to do?</p>
							<div class="btn-group-wrap" style="text-align: center;">
								<div class="btn-group-vertical">
									<button type="button" class="btn btn-default" data-toggle="modal" data-target="#addLocationModal" data-dismiss="modal">Report a Nest</button>
									<button id="goToNavigate" type="button" class="btn btn-default" data-toggle="modal" data-target="#findRouteModal" data-dismiss="modal">Navigate</button>
								</div>
							</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					</div>
				</div>
			</div>
		</div>
		
		<!-- Modal form for adding a location -->
		<div class="modal fade" id="addLocationModal" tabindex="-1" role="dialog" aria-labelledby="addLocLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h4 class="modal-title" id="addLocLabel">Report a Nest Location</h4>
					</div>
					<div class="modal-body">
						<form id="addNestForm" class="form-horizontal">
							
							<div style="text-align: center;">
								<p class="text-center">Where is the Nest?</p>
								<div class="btn-group-wrap" style="text-align: center;">
									<div class="btn-group-vertical">
										<button type="button" class="btn btn-default form-control" data-dismiss="modal" onclick="enablePointSelection()">Click On Map</button>
										<button id="locationLink" type="button" class="btn btn-default form-control" onclick="locateUser()">Use My Location</button>
									</div>
								</div>
								
								<div class="input-group">
									<span id="mapMarker" class="input-group-addon"><i class="fa fa-map-marker"></i></span>
									<input id="coords" disabled="true" type="text" placeholder="" class="form-control"/>
								</div>
							
							</div>
					
							
							<div class="input-group">
								<span class="input-group-addon"><i class="fa fa-comment"></i></span>
								<input id="locDesc" type="text" placeholder="Location description (optional)" class="form-control"/>
							</div>

					
							
							<div class="input-group">
								<span class="input-group-addon"><i class="fa fa-user"></i></span>
								<input id="submitter" type="text" placeholder="Name (optional)" class="form-control"/>
							</div>
						
				
						
							<div class="input-group">
								<span class="input-group-addon"><i class="fa fa-twitter"></i></span>
								<input id="twitterHandle" type="text" placeholder="Twitter handle (optional)" class="form-control"/>
							</div>
							
							
							
							<div class="input-group">
								<span class="input-group-addon"><i class="fa fa-camera"></i></span>
								<input type="file" name="attachment" class="form-control" id="attachment" accept="image/*;capture=camera" />
							</div>
						
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
						<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#submitToTwitterModal" data-dismiss="modal" id="submitNest" disabled=true onclick="saveFeature()">Submit</button>
					</div>
				</div>
			</div>
		</div>
		
		<!-- Modal for also submitting to Twitter -->
		<div class="modal fade" id="submitToTwitterModal" tabindex="-1" role="dialog" aria-labelledby="submitToTwitterLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h4 class="modal-title" id="findRouteLabel">Thanks for your submission to Goosewatch 2014!</h4>
					</div>
					<div class="modal-body">
						<p>
							Your submitted location will be reviewed before being placed on the map. Use the button below if you want to share your submission on Twitter.
						</p>
						<!-- Twitter widget -->
						<a href="https://twitter.com/intent/tweet?button_hashtag=goosewatch2014&text=I%20just%20submitted%20a%20goose%20nest%20location" class="twitter-hashtag-button" data-size="large">Tweet #goosewatch2014</a>
						<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>	
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Modal form for finding a route -->
		<div class="modal fade" id="findRouteModal" tabindex="-1" role="dialog" aria-labelledby="findRouteLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h4 class="modal-title" id="findRouteLabel">Goosewatch 2014 - Find a Route</h4>
					</div>
					<div class="modal-body">
						<form class="form-horizontal">
							<div class="input-group">
								<span class="input-group-addon">From:</span>
								<select id="buildingSelectorA" class="form-control">		
									<!--<option id="myLocOpt" value="gps">My Location</option>-->
									<option value="">--</option>
								</select>
							</div>
							<div class="input-group">
								<span class="input-group-addon">To:</span>
								<select id="buildingSelectorB" class="form-control">
									<option value="">--</option>
								</select>
							</div>
							<div class="input-group">
								<span class="input-group-addon">Fear of Geese</span>
								<select id="fearSelector" class="form-control">
									<option value="0">None</option>
									<option value="1">Cautious</option>
									<option value="2">Terrified</option>
								</select>
							</div>
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
						<button type="button" class="btn btn-primary" data-dismiss="modal" onclick="validateAndAddStops()">Find Route</button>
					</div>
				</div>
			</div>
		</div>

		<div id="nestModal" class="modal fade">
			<div class="modal-dialog">
				<div class="modal-content">
					  <div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h4 class="modal-title">Goose Nest</h4>
					  </div>
					  <div class="modal-body">
						<div id="nestDate"></div>
						<div id="nestDescription"></div>
						<div id="nestSubmitter"></div>
						<div id="nestTwitter"></div>
						<div id="nestImagePlaceholder"></div>
					  </div>
					  <div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					  </div>
				</div>
			</div>
		</div>
		
		<div id="mapDiv"></div>
		
		<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
		<script src="https://code.jquery.com/jquery.js"></script>
		<!-- Include all compiled plugins (below), or include individual files as needed -->
		<script src="js/bootstrap.min.js"></script>
		<!-- modernizr -->
		<script src="js/modernizr-dev.js"></script>
		<!-- Slider JS -->
		<script src="js/bootstrap-slider.js"></script>
		<!-- More Brains -->
		<script src="js/navigation.js"></script>
		<script src="js/reporting.js"></script>
		<script src="js/util.js"></script>
	</body>
</html>
